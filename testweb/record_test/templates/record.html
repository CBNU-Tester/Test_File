<!-- your_template.html -->
{% extends 'base.html' %}

{% block head %}
<!-- ... (your existing head block) ... -->
{% endblock %}

{% block main %}
<div class="container mt-5">
    <form method="post" action="{% url 'process_view' %}" id="url-form">
        {% csrf_token %}

        <!-- + 버튼 -->
        <button type="button" class="btn btn-warning mb-2" id="record-btn">녹화하기</button>
        <button type="submit" class="btn btn-success mb-2">테스트 실행</button>
        <input type="hidden" id="dynamic-inputs" name="dynamic_inputs">

    </form>

    <div id="result-container" class="mt-3">
        <!-- 결과가 띄워지는 곳? -->
    </div>
</div>
{% endblock %}

{% block script %}
<script>
    $(document).ready(function () {
        var inputCount = 1;

        $('#record-btn').click(function () {
            // Ajax 전송
            $.ajax({
                url: '{% url "selenium_record" %}',
                type: 'POST',
                // data: JSON.stringify(formData),
                // contentType: 'application/json',
                success: function (response) {
                    console.log("실험 데이터 전송 성공")
                    //console.log(response.processed_data_list)
                    //loadResult(response.processed_data_list)
                },
                error: function (error) {
                    console.log("실험 데이터 전송 실패")
                    console.error(error);
                }
            });
        });

        // csrf_token 값을 JavaScript 변수에 저장
        let csrftoken = $('[name=csrfmiddlewaretoken]').val();

        $.ajaxSetup({
            headers: { "X-CSRFToken": csrftoken }
        });

        $('#url-form').submit(function (event) {
            event.preventDefault();

            // 데이터 
            var dynamicInputs = [];
            $('.form-group').each(function () {
                dynamicInputs.push({
                    'type': $('#typeSelect-' + this.id.split('-')[1]).val(),
                    'url': $('#url-' + this.id.split('-')[1]).val(),
                    'target': $('#target-' + this.id.split('-')[1]).val(),
                    'input': $('#input-' + this.id.split('-')[1]).val(),
                    'result': $('#result-' + this.id.split('-')[1]).val()
                });
            });

            // Ajax
            var formData = {
                'dynamic_inputs': dynamicInputs
            };

            // Ajax 전송
            $.ajax({
                url: '{% url "process_view" %}',
                type: 'POST',
                data: JSON.stringify(formData),
                contentType: 'application/json',
                success: function (response) {
                    console.log("실험 데이터 전송 성공")
                    //console.log(response.processed_data_list)
                    //loadResult(response.processed_data_list)
                },
                error: function (error) {
                    console.log("실험 데이터 전송 실패")
                    console.error(error);
                }
            });
        });

        function loadResult(data) {
            var processedDataList = data;
            
            $('#result-container').empty();

            var resultContainer = $('<div class="mt-3">결과</div>');

            for (var i = 0; i < processedDataList.length; i++) {
                var processedData = processedDataList[i];

                var resultItem = $('<div>' +
                    i + '번째 테스트' + ', 테스트 결과 : ' + processedData.processed_data +
                    '</div>');

                resultContainer.append(resultItem);
            }
            $('#result-container').append(resultContainer);
        }

    });
</script>
{% endblock %}